version: 2

sources:
  - name: dev_bronze                         # dbt source name
    database: logistics               # Snowflake database
    schema: dev_bronze                       # schema where bronze lives
    tables:
      - name: bronze_dim_customer
      - name: bronze_dim_store
      - name: bronze_dim_product
      - name: bronze_dim_date
      - name: bronze_fact_sales
      - name: bronze_fact_returns


{# WITH customers as (
    SELECT * FROM {{ source('dev_bronze','bronze_dim_customer') }}
    {# SELECT * FROM {{ ref("bronze_dim_customer") }} #}
)
SELECT * FROM customers #}

WITH customers AS (
    SELECT * FROM {{ ref("bronze_dim_customer") }}
),
deduplicate_customers AS (
    SELECT
        customer_sk as customer_id,
        customer_code,
        first_name,
        last_name,
        gender,
        email,
        phone,
        loyalty_tier,
        signup_date,
        ROW_NUMBER() OVER(PARTITION BY customer_sk ORDER BY signup_date DESC) AS row_count
    FROM customers
)
SELECT * FROM deduplicate_customers WHERE row_count = 1

-- Check for duplicate customer_id

SELECT
    customer_sk AS customer_id,
    COUNT(*) AS duplicate_customer_id
FROM
    {{ ref("bronze_dim_customer") }}
GROUP BY 
    customer_sk
HAVING 
    COUNT(*) > 1
ORDER BY 
    duplicate_customer_id;


    CHECK FOR NULL VALUES
    =================
WITH products AS (
    SELECT * FROM {{ ref("bronze_dim_product") }}
)
SELECT
SUM(CASE WHEN product_sk IS NULL THEN 1 ELSE 0 END) AS product_sk_null,
SUM(CASE WHEN product_code IS NULL THEN 1 ELSE 0 END) AS product_code_null,
SUM(CASE WHEN product_name IS NULL THEN 1 ELSE 0 END) AS product_name_null,
SUM(CASE WHEN department IS NULL THEN 1 ELSE 0 END) AS department_null,
SUM(CASE WHEN category IS NULL THEN 1 ELSE 0 END) AS category_null,
SUM(CASE WHEN supplier_sk IS NULL THEN 1 ELSE 0 END) AS supplier_sk_id,
SUM(CASE WHEN list_price IS NULL THEN 1 ELSE 0 END) AS list_price_null 
FROM products



